<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PosApp - Tổng kết Giờ chơi và Doanh thu Bàn Bida</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <style>
        .card {
            margin-bottom: 20px;
        }

        .summary-box {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

            .summary-box h3 {
                margin-bottom: 10px;
            }

        .top-tables {
            background-color: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

            .top-tables h3 {
                margin-bottom: 10px;
            }

            .top-tables ul {
                list-style-type: none;
                padding-left: 0;
            }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Tổng kết Giờ chơi và Doanh thu Bàn Bida</h1>

        <div class="row mb-4">
            <div class="col-md-3">
                <select class="form-select" id="reportType">
                    <option value="day">Theo ngày</option>
                    <option value="week">Theo tuần</option>
                    <option value="month">Theo tháng</option>
                    <option value="quarter">Theo quý</option>
                    <option value="year">Theo năm</option>
                </select>
            </div>
            <div class="col-md-5">
                <input type="text" class="form-control" id="dateRange" placeholder="Chọn khoảng thời gian">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="tableType">
                    <option value="all">Tất cả bàn</option>
                    <option value="pool">Bàn Pool</option>
                    <option value="snooker">Bàn Snooker</option>
                    <option value="carom">Bàn Carom</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" id="generateReport">Tạo báo cáo</button>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="summary-box">
                    <h3>Tổng giờ chơi</h3>
                    <h2 id="totalHours">0 giờ</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-box">
                    <h3>Tổng doanh thu</h3>
                    <h2 id="totalRevenue">0 đ</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-box">
                    <h3>Giá trung bình/giờ</h3>
                    <h2 id="averageRate">0 đ/giờ</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="top-tables">
                    <h3>Top 5 bàn được sử dụng nhiều nhất</h3>
                    <ul id="topTablesList">
                        <!-- Danh sách sẽ được điền bằng JavaScript -->
                    </ul>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Biểu đồ Giờ chơi và Doanh thu</h5>
                <canvas id="billiardChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Chi tiết theo Bàn</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Bàn</th>
                            <th>Loại</th>
                            <th>Số giờ chơi</th>
                            <th>Doanh thu</th>
                            <th>Tỷ lệ sử dụng</th>
                        </tr>
                    </thead>
                    <tbody id="tableDetailsBody">
                        <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="text-end mt-3">
            <button class="btn btn-success me-2" id="exportPDF">Xuất PDF</button>
            <button class="btn btn-success" id="exportExcel">Xuất Excel</button>
        </div>
    </div>

    <script>
        let billiardChart;

        $(document).ready(function () {
            $('#dateRange').daterangepicker({
                opens: 'left',
                locale: {
                    format: 'DD/MM/YYYY'
                }
            });

            const ctx = document.getElementById('billiardChart').getContext('2d');
            billiardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Giờ chơi',
                            data: [],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            yAxisID: 'y-axis-1',
                        },
                        {
                            label: 'Doanh thu',
                            data: [],
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            yAxisID: 'y-axis-2',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        'y-axis-1': {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Giờ chơi'
                            }
                        },
                        'y-axis-2': {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Doanh thu (đ)'
                            }
                        }
                    }
                }
            });

            $('#generateReport').click(generateReport);
            $('#exportPDF').click(exportPDF);
            $('#exportExcel').click(exportExcel);
        });

        function generateReport() {
            const reportType = $('#reportType').val();
            const dateRange = $('#dateRange').val();
            const tableType = $('#tableType').val();

            // Giả lập dữ liệu (trong thực tế, bạn sẽ gọi API để lấy dữ liệu)
            const data = generateMockData(reportType, dateRange, tableType);

            updateChart(data);
            updateSummary(data);
            updateTopTables(data);
            updateTableDetails(data);
        }

        function generateMockData(reportType, dateRange, tableType) {
            // Giả lập dữ liệu cho mục đích demo
            const tables = [
                { name: 'Bàn 1', type: 'pool' },
                { name: 'Bàn 2', type: 'pool' },
                { name: 'Bàn 3', type: 'snooker' },
                { name: 'Bàn 4', type: 'snooker' },
                { name: 'Bàn 5', type: 'carom' },
                { name: 'Bàn 6', type: 'carom' }
            ];

            const data = tables.map(table => {
                const hours = Math.floor(Math.random() * 50) + 10;
                const revenue = hours * (Math.floor(Math.random() * 50000) + 100000);
                return {
                    ...table,
                    hours,
                    revenue,
                    usageRate: Math.random() * 0.8 + 0.2 // 20-100% tỷ lệ sử dụng
                };
            });

            if (tableType !== 'all') {
                return data.filter(item => item.type === tableType);
            }

            return data;
        }

        function updateChart(data) {
            billiardChart.data.labels = data.map(item => item.name);
            billiardChart.data.datasets[0].data = data.map(item => item.hours);
            billiardChart.data.datasets[1].data = data.map(item => item.revenue);
            billiardChart.update();
        }

        function updateSummary(data) {
            const totalHours = data.reduce((sum, item) => sum + item.hours, 0);
            const totalRevenue = data.reduce((sum, item) => sum + item.revenue, 0);
            const averageRate = totalHours > 0 ? totalRevenue / totalHours : 0;

            $('#totalHours').text(totalHours.toFixed(2) + ' giờ');
            $('#totalRevenue').text(formatCurrency(totalRevenue));
            $('#averageRate').text(formatCurrency(averageRate) + '/giờ');
        }

        function updateTopTables(data) {
            const sortedTables = [...data].sort((a, b) => b.hours - a.hours).slice(0, 5);
            const topTablesList = $('#topTablesList');
            topTablesList.empty();

            sortedTables.forEach(table => {
                topTablesList.append(`<li>${table.name} - ${table.hours.toFixed(2)} giờ</li>`);
            });
        }

        function updateTableDetails(data) {
            const tableBody = $('#tableDetailsBody');
            tableBody.empty();

            data.forEach(item => {
                tableBody.append(`
                            <tr>
                                <td>${item.name}</td>
                                <td>${getTableTypeText(item.type)}</td>
                                <td>${item.hours.toFixed(2)} giờ</td>
                                <td>${formatCurrency(item.revenue)}</td>
                                <td>${(item.usageRate * 100).toFixed(2)}%</td>
                            </tr>
                        `);
            });
        }

        function getTableTypeText(type) {
            switch (type) {
                case 'pool': return 'Pool';
                case 'snooker': return 'Snooker';
                case 'carom': return 'Carom';
                default: return 'Khác';
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function exportPDF() {
            alert('Chức năng xuất PDF sẽ được thực hiện ở đây');
            // Trong thực tế, bạn sẽ sử dụng thư viện như jsPDF để tạo file PDF
        }

        function exportExcel() {
            alert('Chức năng xuất Excel sẽ được thực hiện ở đây');
            // Trong thực tế, bạn sẽ sử dụng thư viện như SheetJS để tạo file Excel
        }
    </script>
</body>
</html>