@using PingMeChat.CMS.Application.Feature.Service.BidaTableSessionServicess.Dto
@using PingMeChat.CMS.Entities.Feature
@model BidaTableSessionPaymentDto
<div class="modal-content bg-primary text-white">
    <div class="modal-header">
        <h5 class="modal-title" id="featureModalLabel">Tính năng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <div class="modal-scroll"
             style="max-height: 70vh; overflow-y: auto; overflow-x: hidden; scrollbar-width: none;">
            <div class="row text-center mb-4 row-cols-3 row-cols-md-4 g-4">
                <div class="col">
                    <div class="feature-item" id="openServiceModal">
                        <i class="fas fa-tags"></i>
                        <span>Dịch vụ</span>
                    </div>
                </div>
                <div class="col">
                    <div class="feature-item" data-bs-toggle="modal" data-bs-target="#confirmPaymentModal">
                        <i class="bi bi-cash-coin"></i>
                        <span>Thanh toán</span>
                    </div>
                </div>
                <div class="col">
                    <div class="feature-item" data-bs-toggle="modal" data-bs-target="#confirmDebtModal">
                        <i class="bi bi-credit-card-2-back-fill"></i>
                        <span>Thanh toán - Ghi nợ</span>
                    </div>
                </div>
                <div class="col">
                    <div class="feature-item" data-bs-toggle="modal"
                         data-bs-target="#confirmMoveTableModal">
                        <i class="bi bi-arrow-left-right"></i>
                        <span>Chuyển bàn</span>
                    </div>
                </div>
                <div class="col">
                    <div class="feature-item" data-bs-toggle="modal"
                         data-bs-target="#confirmSpiltHourModal">
                        <i class="bi bi-clock-history"></i>
                        <span>Tách giờ</span>
                    </div>
                </div>

                <div class="col">
                    <div class="feature-item">
                        <i class="bi bi-person-badge"></i>
                        <span>Thẻ thành viên</span>
                    </div>
                </div>

                <div class="col">
                    <div class="feature-item">
                        <i class="bi bi-power"></i>
                        <span>Lịch sử bật/tắt điện</span>
                    </div>
                </div>
                <div class="col">
                    <div class="feature-item">
                        <i class="bi bi-clock-history"></i>
                        <span>Lịch sử người dùng</span>
                    </div>
                </div>
            </div>

            <div class="row g-4 mt-4">
                <div class="col-md-6">
                    <div class="card text-dark border border-white">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-info-circle-fill me-2"></i>Thông tin bàn
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                @{
                                    var currentTotalAmount = Model.TotalPrice + Model.TotalServicePrice;
                                    var orderHistoriesTotalAmount = Model.OrderHistories?.Sum(x => x.TotalAmount) ?? 0;
                                    var totalAmount = currentTotalAmount + orderHistoriesTotalAmount;
                                }
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span> <i class="bi bi-tag-fill me-2"></i>Bàn:</span>
                                    <span class="fw-bold">@Model.Code - @Model.BidaTableTypeName</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-currency-dollar me-2"></i>Giá/giờ:</span>
                                    <span class="fw-bold text-success">@Model.Price.FormatToCurrency()</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span> <i class="bi bi-clock-fill me-2"></i>Tiền bàn (bill hiện tại):</span>
                                    <span class="fw-bold">@Model.TotalPrice.FormatToCurrency()</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span> <i class="bi bi-cart-fill me-2"></i>Tổng tiền dịch vụ:</span>
                                    <span class="fw-bold">@Model.TotalServicePrice.FormatToCurrency()</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-receipt me-2"></i>Tổng tiền bill hiện tại:</span>
                                    <span class="fw-bold">@((Model.TotalPrice + Model.TotalServicePrice).FormatToCurrency())</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span> <i class="bi bi-clock-history me-2"></i>Tiền các bill trước:</span>
                                    <span class="fw-bold">@orderHistoriesTotalAmount.FormatToCurrency()</span>
                                </li>
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span><i class="bi bi-percent me-2"></i>Giảm giá:</span>
                                        <div class="input-group" style="max-width: 200px;">
                                            <input type="number" id="discountValue" class="form-control" min="0" max="@totalAmount" step="0.01">
                                            <select id="discountType" class="form-select" style="max-width: 80px;">
                                                <option value="1" selected>₫</option>
                                                <option value="0">%</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="fw-bold" id="discountDisplay"></span>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-cash-stack me-2"></i>Tổng cộng:</span>
                                    <span class="fw-bold text-danger" data-value="@totalAmount">@totalAmount.FormatToCurrency()</span>
                                </li>
                            </ul>
                        </div>

                    </div>
                    <div class="card text-dark border border-white mt-3">
                        <div class="card-header bg-warning text-dark">
                            <i class="bi bi-clock-history me-2"></i>Thông tin thời gian
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-clock me-2"></i>Bắt đầu:</span>
                                    <span class="time-badge">@Model.StartTime.ToString("HH:mm - dd/MM/yyyy")</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="bi bi-clock-fill me-2"></i>Tổng thời gian (tính đến hiện tại):</span>
                                    <span class="time-badge">@Model.TotalTimeString</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-dark border border-white">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-cart4 me-2"></i>Dịch vụ đã sử dụng
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                @foreach (var item in Model.SessionServiceDtos)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-cup-straw me-2"></i>@item.ProductName</span>
                                        <span>
                                            <span class="badge bg-primary rounded-pill me-2">@item.Quantity</span>
                                            <span class="text-muted">@((item.Price * item.Quantity).FormatToCurrency())</span>
                                        </span>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                    <div id="order-history" class="card text-dark border border-white mt-3">
                        <div class="card-header bg-secondary text-white">
                            <i class="bi bi-receipt me-2"></i>Lịch sử hóa đơn và thao tác
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                @foreach (var item in Model.OrderHistories)
                                {
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>
                                                @{
                                                    var description = item.Description;
                                                    var isChangeTable = description.ToUpper().Contains("CHUYỂN BÀN"); //Kiểm tra đây là hoá đơn chuyển bàn hay tách giờ
                                                }
                                                <i class="bi @(isChangeTable? "bi-arrow-left-right" : "bi-file-earmark-text")  me-2"></i>
                                                Hóa đơn <span class="text-bold">#@item.Code</span>
                                            </span>
                                            <span class="badge bg-success">@item.TotalAmount.FormatToCurrency()</span>
                                        </div>
                                        <small class="text-muted">@description - @item.CreatedDate.ToString("HH:mm - dd/MM/yyyy")</small>
                                        <div class="details">
                                            <table class="table table-borderless table-info">
                                                <tbody>
                                                    <tr>
                                                        <td>Tiền bàn:</td>
                                                        <td class="text-end">@item.BidaTableAmount.FormatToCurrency()</td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            Dịch vụ sử dụng:
                                                        </td>
                                                        <td class="text-end">@item.TotalServiceAmount?.FormatToCurrency()</td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan="2" class="p-0">
                                                            <div>
                                                                <table class="table table-sm table-borderless mb-0">
                                                                    <tbody>
                                                                        @foreach (var service in item.OrderDetails)
                                                                        {
                                                                            <tr>
                                                                                <td class="small text-muted ps-3">@service.ProductName</td>
                                                                                <td class="small text-muted text-end">
                                                                                    @service.Quantity x @service.UnitPrice.FormatToCurrency() = @((service.Quantity * service.UnitPrice).FormatToCurrency())
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </td>
                                                    </tr>

                                                    <tr>
                                                        <td>Tổng cộng:</td>
                                                        <td class="text-end fw-bold">@item.TotalAmount.FormatToCurrency()</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </li>
                                }

                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="modal-footer footer-fixed">
        <div class="container d-flex justify-content-between align-items-center fs-6 w-100 p-3 border">
            <div>
                <i class="fas fa-bookmark"></i> <span id="code-name-table" class="text-bold">@Model.Code</span>
            </div>

            <div class="text-bold">
                Tổng tiền: <span id="totalAmount" data-value="@totalAmount">@totalAmount.FormatToCurrency()</span>
            </div>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
    </div>
</div>
